# Certificate Generation

As stated in previous page, anti-virus generates root certificates to verify contents they intercepted. These root certificates are stored in the Windows certificate store on user's computer. For us to identify how anti-virus generate their root certificates, we must first identify the time when it is first created. Our method is simple, as we continuously monitor the certificate store during the installation process until a root certificate with the anti-virus name appear. 


### Dr. Web
Dr. Web does not install the root certificate in the initial installation process, the certificate is generated only when the user specifies it. In Dr. Web's UI it presents the option to scan encrypted traffic. Once this option is selected, a root certificate is generated and can be seen in the certificate store. It is worth noting that the root certificate is attached with a private key, with a message: "You have a private key that corresponds to this certificate". This also gave us to the opportunity to use the private key and sign certificates in a server. 

To understand how it was generated, we wanted to investigate the source code. However, there was no decomplier that we can use to generate readable codes. We were able to use Detect-It-Easy to look at the embedded strings. From the string content, we found key words such as sha284RSA and other RSA cipher, but none of this give us enough information. 

Next step, we use Process monitor in Microsoft SysInternal to monitor the computer activity. We found that once the option to scan encrypted traffic is selected, the executable dwnetfilter.exe began query different cryptography libraires, such as bcrypt.dll and cryptsp.dll in the Windows System32 folder. These are Cryptographic Service Provider API that belongs Windows OS and we believe they use these libraries to generate key pairs for root certificates. We also found that dwnetfilter.exe access C:\ProgramData\Microsoft\RSA\MachineKeys and generated a system file with long string of seemingly random generated numbers for its name. Using Notepad with administration rights, we opened the system file and found what appears to be encrypted data, with some legible words such as "RSA" and "CryptoAPI Private Key". We decided to test if this file is essential to Dr. Web's ability to intercept traffic. 

The first method was to remove this file from the folder and see what happens. When the encrypted traffic option is enabled, the browser could not access any websites. It simply shows that sites are unreachable. We investigated the log file for Dr. Web, and it shows that it is connecting to the websites we specified. From this, our assumption was that Dr. Web may be using this key file to dynamically sign certificates for websites. When the key file is gone, Dr. Web could not create a HTTP content with data received from the website, thus it cannot send data to the browser. 

To verify this, we kept the key file and uninstall Dr. web. We deleted all files that are correlated to Dr. Web including logs files and the root certificate installed, which was not uninstalled with the program. The idea was to prevent fingerprinting from Dr. Web so it will generate a new root certificate and private key. With the new root certificate installed and new private key located, we removed the new private key and replace it with the old private key file. It is worth noting that the new key file has the exact same name as the old key file, which was supposedly a long random generated number. This means that the key file created are based on certain features in the user's computer. After we access a new website with the old private key, the browser said the website we are accessing are untrustworthy. 

We concluded that this key file is indeed used by Dr. Web to sign certificate for websites. When old key file is being used, it became a mismatch with the new root certificate the browser has. Since Dr. Web is signing certificate with old key file, the new root certificate does not verify it and the website we want to access is then been interpreted as unsecure and unsafe.

  


### Avast and AVG
Avast and AVG works very similar in our experiment, almost identical. Each software installs root certificate at application install time. The installation time is around 5 minutes, which we were not able to use process monitor for an extended period. The private key for the certificate is not attached like Dr. Web thus we were not able create the same DEMO as Dr. Web. After installation, 3 new root certificates are found in the store, Web/Mail Shield Root, Web/Mail Self-Signed Root, Web/Mail Untrusted Root. These 3 certificates are used for different purposes. Shield root is signed to regular websites with legitimate certificates, self-signed root is given to websites with self-singed certificates, and untrusted root are given to websites with untrusted certificates. AVG and Avast basically assign certificates to all traffic they intercepted, unlike Dr. Web, where self-signed and untrusted are given directly to the browser. The end-result is the same, as all anti-viruses gave untrusted certificates to browser which the browser will show warnings. Also, whenever the browser accesses a website, a new certificate signed by the anti-virus that is associated with this website is stored in the Windows certificate store. This could be a method for Anti-virus to only scan website once to be more efficient. 

In the MachineKeys Folder, 3 keys are stored there which should be compatible to the 3 root certificates generated. However, we were unable to use the same testing method as we did in Dr. Web by removing the key files. Once we remove a key file, they are automatically generated again back into the folder. Thus, we were unable to identify which key file belongs to which root certificates.
